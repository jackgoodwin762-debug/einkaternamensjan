<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog - einkaternamensjan</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Language toggle */
    .language-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 0.5rem;
      background: rgba(255,255,255,0.1);
      padding: 0.5rem;
      border-radius: 6px;
      backdrop-filter: blur(10px);
    }

    .language-toggle button {
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: inherit;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .language-toggle button:hover {
      background: rgba(255,255,255,0.2);
    }

    .language-toggle button.active {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.4);
      font-weight: bold;
    }

    /* Footnotes styling */
    .footnotes {
      margin-top: 3rem;
      padding-top: 1.5rem;
      border-top: 2px solid rgba(255,255,255,0.2);
    }

    .footnotes h4 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .footnotes ol {
      padding-left: 1.5rem;
      line-height: 1.8;
    }

    .footnotes li {
      margin-bottom: 0.75rem;
    }

    .footnote-ref {
      color: #64a0ff;
      text-decoration: none;
      font-weight: bold;
      vertical-align: super;
      font-size: 0.8em;
      padding: 0 0.2em;
    }

    .footnote-ref:hover {
      text-decoration: underline;
    }

    .footnote-backref {
      color: #64a0ff;
      text-decoration: none;
      margin-left: 0.5rem;
      font-size: 0.9em;
    }

    .footnote-backref:hover {
      text-decoration: underline;
    }

    /* Comment section styling */
    .comment-section {
      max-width: 20cm;
      margin: 3rem auto 4rem;
      padding: 1.5rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
    }
    
    .comment-section h3 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }

    /* Comment form */
    .comment-form {
      margin-bottom: 2rem;
      padding: 1rem;
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
    }

    .comment-form input,
    .comment-form textarea {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: inherit;
      font-family: inherit;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .comment-form textarea {
      min-height: 100px;
      resize: vertical;
    }

    .comment-form button {
      padding: 0.75rem 1.5rem;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      color: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .comment-form button:hover {
      background: rgba(255,255,255,0.3);
    }

    .comment-form button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Comments list */
    .comments-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .comment {
      padding: 1rem;
      margin-bottom: 1rem;
      background: rgba(255,255,255,0.03);
      border-left: 3px solid rgba(255,255,255,0.3);
      border-radius: 4px;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .comment-author {
      font-weight: bold;
    }

    .comment-date {
      font-style: italic;
    }

    .comment-text {
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .no-comments {
      text-align: center;
      padding: 2rem;
      opacity: 0.6;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 1rem;
      opacity: 0.6;
    }

    /* Article spacing */
    article {
      margin-bottom: 4rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    article:last-of-type {
      border-bottom: none;
    }

    /* Translation notice */
    .translation-notice {
      background: rgba(100, 150, 255, 0.15);
      border-left: 3px solid rgba(100, 150, 255, 0.5);
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .translation-error {
      background: rgba(255, 100, 100, 0.15);
      border-left: 3px solid rgba(255, 100, 100, 0.5);
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="language-toggle">
    <button class="active" id="lang-en">English</button>
    <button id="lang-de">Deutsch</button>
  </div>

  <header>
    <h1>Blog</h1>
    <p><a href="index.html">Back to Home</a></p>
  </header>
  <nav aria-label="Contents">
    <h2>Contents</h2>
    ###BLOG-CONTENTS###
  </nav>
  <main>
    ###BLOGS###
  </main>

  <script>
    var COMMENTS_KEY = 'blog_comments';
    var TRANSLATIONS_KEY = 'blog_translations';
    var CURRENT_LANG_KEY = 'blog_current_lang';
    var FOOTNOTES_KEY = 'blog_footnotes';

    var commentsStore = loadCommentsFromStorage();
    var translationsCache = loadTranslationsFromStorage();
    var footnotesStore = loadFootnotesFromStorage();
    var currentLang = localStorage.getItem(CURRENT_LANG_KEY) || 'en';
    var originalContent = new Map();
    var articleLanguages = new Map(); // Track the original language of each article

    function loadCommentsFromStorage() {
      try {
        var stored = localStorage.getItem(COMMENTS_KEY);
        return stored ? JSON.parse(stored) : {};
      } catch (e) {
        console.error('Error loading comments:', e);
        return {};
      }
    }

    function saveCommentsToStorage(comments) {
      try {
        localStorage.setItem(COMMENTS_KEY, JSON.stringify(comments));
      } catch (e) {
        console.error('Error saving comments:', e);
      }
    }

    function loadTranslationsFromStorage() {
      try {
        var stored = localStorage.getItem(TRANSLATIONS_KEY);
        return stored ? JSON.parse(stored) : {};
      } catch (e) {
        console.error('Error loading translations:', e);
        return {};
      }
    }

    function saveTranslationsToStorage(translations) {
      try {
        localStorage.setItem(TRANSLATIONS_KEY, JSON.stringify(translations));
      } catch (e) {
        console.error('Error saving translations:', e);
      }
    }

    function loadFootnotesFromStorage() {
      try {
        var stored = localStorage.getItem(FOOTNOTES_KEY);
        return stored ? JSON.parse(stored) : {};
      } catch (e) {
        console.error('Error loading footnotes:', e);
        return {};
      }
    }

    function saveFootnotesToStorage(footnotes) {
      try {
        localStorage.setItem(FOOTNOTES_KEY, JSON.stringify(footnotes));
      } catch (e) {
        console.error('Error saving footnotes:', e);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      var articles = document.querySelectorAll('main article');
      
      articles.forEach(function(article, index) {
        if (!article.id) {
          var heading = article.querySelector('h2, h3');
          var slug = heading ? heading.textContent.toLowerCase().replace(/[^a-z0-9]+/g, '-') : 'post-' + index;
          article.id = slug;
        }
        
        // Store original content without comment section and footnotes
        var clone = article.cloneNode(true);
        var existingComments = clone.querySelector('.comment-section');
        var existingFootnotes = clone.querySelector('.footnotes');
        if (existingComments) existingComments.remove();
        if (existingFootnotes) existingFootnotes.remove();
        originalContent.set(article.id, clone.innerHTML);
        
        // Detect the language of this article
        var articleText = clone.textContent.trim();
        var detectedLang = detectLanguage(articleText);
        articleLanguages.set(article.id, detectedLang);
        console.log('Article "' + article.id + '" detected language:', detectedLang);
        
        if (!commentsStore[article.id]) {
          commentsStore[article.id] = [];
        }
        
        if (!footnotesStore[article.id]) {
          footnotesStore[article.id] = [];
        }
        
        // Process existing footnotes from content
        processFootnotes(article);
        
        // Add footnotes section
        renderFootnotes(article.id);
        
        // Add comment section if it doesn't exist
        if (!article.querySelector('.comment-section')) {
          var commentSection = createCommentSection(article.id);
          article.appendChild(commentSection);
        }
        renderComments(article.id);
      });

      document.getElementById('lang-en').addEventListener('click', function() {
        switchLanguage('en');
      });
      document.getElementById('lang-de').addEventListener('click', function() {
        switchLanguage('de');
      });

      updateLanguageButtons();
      if (currentLang === 'de') {
        translateAllArticles('de');
      } else if (currentLang === 'en') {
        translateAllArticles('en');
      }
    });

    function detectLanguage(text) {
      // Simple language detection based on common words
      // Take a sample of the text (first 500 characters)
      var sample = text.substring(0, 500).toLowerCase();
      
      // German indicators
      var germanWords = ['und', 'der', 'die', 'das', 'ich', 'ist', 'nicht', 'sie', 'mit', 'auf', 'für', 'ein', 'eine', 'auch', 'sich', 'werden', 'aus', 'aber', 'über', 'können', 'müssen', 'sollte', 'würde', 'schon', 'mehr', 'durch', 'beim', 'zur', 'vom', 'zum'];
      var germanChars = ['ä', 'ö', 'ü', 'ß'];
      
      // English indicators
      var englishWords = ['the', 'and', 'is', 'in', 'to', 'of', 'that', 'it', 'for', 'on', 'with', 'as', 'was', 'at', 'be', 'this', 'have', 'from', 'or', 'one', 'had', 'by', 'but', 'not', 'what', 'all', 'were', 'when', 'there', 'can'];
      
      var germanScore = 0;
      var englishScore = 0;
      
      // Check for German special characters (strong indicator)
      germanChars.forEach(function(char) {
        if (sample.indexOf(char) !== -1) {
          germanScore += 5; // Strong indicator
        }
      });
      
      // Count word matches
      germanWords.forEach(function(word) {
        var regex = new RegExp('\\b' + word + '\\b', 'gi');
        var matches = sample.match(regex);
        if (matches) {
          germanScore += matches.length;
        }
      });
      
      englishWords.forEach(function(word) {
        var regex = new RegExp('\\b' + word + '\\b', 'gi');
        var matches = sample.match(regex);
        if (matches) {
          englishScore += matches.length;
        }
      });
      
      console.log('Language detection scores - German:', germanScore, 'English:', englishScore);
      
      // Return the language with higher score, default to English
      return germanScore > englishScore ? 'de' : 'en';
    }

    function processFootnotes(article) {
      var articleId = article.id;
      var content = article.innerHTML;
      
      // Look for footnote patterns like [1], [2], etc.
      var footnotePattern = /\[(\d+)\]/g;
      var match;
      var footnoteRefs = [];
      
      while ((match = footnotePattern.exec(content)) !== null) {
        footnoteRefs.push({
          number: parseInt(match[1]),
          index: match.index
        });
      }
      
      // Replace footnote markers with proper links
      if (footnoteRefs.length > 0) {
        var newContent = content;
        for (var i = footnoteRefs.length - 1; i >= 0; i--) {
          var ref = footnoteRefs[i];
          var before = newContent.substring(0, ref.index);
          var after = newContent.substring(ref.index + ('[' + ref.number + ']').length);
          newContent = before + '<a href="#fn-' + articleId + '-' + ref.number + '" class="footnote-ref" id="fnref-' + articleId + '-' + ref.number + '">[' + ref.number + ']</a>' + after;
        }
        article.innerHTML = newContent;
      }
    }

    function renderFootnotes(postId) {
      var article = document.getElementById(postId);
      if (!article) return;
      
      var footnotes = footnotesStore[postId] || [];
      
      // Remove existing footnotes section
      var existingFootnotes = article.querySelector('.footnotes');
      if (existingFootnotes) {
        existingFootnotes.remove();
      }
      
      if (footnotes.length === 0) return;
      
      var footnotesSection = document.createElement('div');
      footnotesSection.className = 'footnotes';
      
      var heading = document.createElement('h4');
      heading.textContent = 'Footnotes';
      footnotesSection.appendChild(heading);
      
      var ol = document.createElement('ol');
      footnotes.forEach(function(footnote) {
        var li = document.createElement('li');
        li.id = 'fn-' + postId + '-' + footnote.number;
        li.innerHTML = escapeHtml(footnote.text) + ' <a href="#fnref-' + postId + '-' + footnote.number + '" class="footnote-backref">↩</a>';
        ol.appendChild(li);
      });
      
      footnotesSection.appendChild(ol);
      
      // Insert before comment section
      var commentSection = article.querySelector('.comment-section');
      if (commentSection) {
        article.insertBefore(footnotesSection, commentSection);
      } else {
        article.appendChild(footnotesSection);
      }
    }

    function updateLanguageButtons() {
      document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');
      document.getElementById('lang-de').classList.toggle('active', currentLang === 'de');
    }

    function switchLanguage(lang) {
      if (lang === currentLang) return;
      
      currentLang = lang;
      localStorage.setItem(CURRENT_LANG_KEY, lang);
      updateLanguageButtons();

      // Always translate to the selected language
      translateAllArticles(lang);
    }

    function restoreOriginalContent() {
      var articles = document.querySelectorAll('main article');
      articles.forEach(function(article) {
        var original = originalContent.get(article.id);
        if (original) {
          var commentSection = article.querySelector('.comment-section');
          article.innerHTML = original;
          processFootnotes(article);
          renderFootnotes(article.id);
          if (commentSection) {
            article.appendChild(commentSection);
          }
        }
      });
    }

    function translateAllArticles(targetLang) {
      var articles = document.querySelectorAll('main article');
      articles.forEach(function(article) {
        var sourceLang = articleLanguages.get(article.id) || 'en';
        
        // Only translate if source and target languages are different
        if (sourceLang === targetLang) {
          // Restore original content if already in target language
          var original = originalContent.get(article.id);
          if (original) {
            var commentSection = article.querySelector('.comment-section');
            article.innerHTML = original;
            processFootnotes(article);
            renderFootnotes(article.id);
            if (commentSection) {
              article.appendChild(commentSection);
            }
          }
        } else {
          translateArticle(article, targetLang, sourceLang);
        }
      });
    }

    function translateArticle(article, targetLang, sourceLang) {
      var articleId = article.id;
      var cacheKey = articleId + '_' + sourceLang + '_' + targetLang;
      
      // Check cache first
      if (translationsCache[cacheKey]) {
        var commentSection = article.querySelector('.comment-section');
        article.innerHTML = translationsCache[cacheKey];
        renderFootnotes(articleId);
        if (commentSection) {
          article.appendChild(commentSection);
        }
        return;
      }

      // Show translating notice
      var commentSection = article.querySelector('.comment-section');
      var original = originalContent.get(articleId);
      if (!original) return;

      article.innerHTML = original;
      
      var notice = document.createElement('div');
      notice.className = 'translation-notice';
      notice.textContent = 'Translating...';
      article.insertBefore(notice, article.firstChild);

      // Extract all text nodes that need translation
      var textElements = [];
      extractTextElements(article, textElements);
      
      // Translate each text element
      var translatedCount = 0;
      var totalCount = textElements.length;

      if (totalCount === 0) {
        notice.remove();
        renderFootnotes(articleId);
        if (commentSection) {
          article.appendChild(commentSection);
        }
        return;
      }

      textElements.forEach(function(elem) {
        var originalText = elem.textContent.trim();
        if (originalText.length > 0) {
          translateWithLibreTranslate(originalText, targetLang, sourceLang).then(function(translated) {
            if (translated) {
              elem.textContent = translated;
            }
            translatedCount++;
            
            if (translatedCount === totalCount) {
              var langNames = {
                'en': 'English',
                'de': 'German'
              };
              notice.textContent = 'Translated from ' + langNames[sourceLang] + ' to ' + langNames[targetLang];
              notice.className = 'translation-notice';
              
              // Cache the translation
              var clone = article.cloneNode(true);
              var cloneComments = clone.querySelector('.comment-section');
              var cloneFootnotes = clone.querySelector('.footnotes');
              if (cloneComments) cloneComments.remove();
              if (cloneFootnotes) cloneFootnotes.remove();
              translationsCache[cacheKey] = clone.innerHTML;
              saveTranslationsToStorage(translationsCache);
              
              renderFootnotes(articleId);
              if (commentSection) {
                article.appendChild(commentSection);
              }
            }
          }).catch(function(error) {
            console.error('Translation failed:', error);
            translatedCount++;
            
            if (translatedCount === totalCount) {
              notice.textContent = 'Translation failed. Please try again later.';
              notice.className = 'translation-error';
              
              renderFootnotes(articleId);
              if (commentSection) {
                article.appendChild(commentSection);
              }
            }
          });
        } else {
          translatedCount++;
        }
      });
    }

    function extractTextElements(node, results) {
      // Skip comment sections, footnotes, and code blocks
      if (node.classList && (node.classList.contains('comment-section') || 
          node.classList.contains('footnotes') ||
          node.classList.contains('translation-notice') ||
          node.classList.contains('translation-error'))) {
        return;
      }

      if (node.tagName === 'CODE' || node.tagName === 'PRE' || 
          node.tagName === 'SCRIPT' || node.tagName === 'STYLE' ||
          node.tagName === 'A') {
        return;
      }

      // If it's a text node, check if it has meaningful content
      if (node.nodeType === Node.TEXT_NODE) {
        var text = node.textContent.trim();
        if (text.length > 0) {
          results.push(node);
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        // Recurse into child nodes
        for (var i = 0; i < node.childNodes.length; i++) {
          extractTextElements(node.childNodes[i], results);
        }
      }
    }

    function translateWithLibreTranslate(text, targetLang, sourceLang) {
      return new Promise(function(resolve, reject) {
        // Split long texts
        if (text.length > 500) {
          var sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
          var promises = sentences.map(function(sentence) {
            return translateSingleText(sentence.trim(), targetLang, sourceLang);
          });
          
          Promise.all(promises).then(function(results) {
            resolve(results.join(' '));
          }).catch(reject);
        } else {
          translateSingleText(text, targetLang, sourceLang).then(resolve).catch(reject);
        }
      });
    }
    
    function translateSingleText(text, targetLang, sourceLang) {
      return new Promise(function(resolve, reject) {
        // Use Google Translate's unofficial API via translate.googleapis.com
        var url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=' + sourceLang + '&tl=' + targetLang + '&dt=t&q=' + encodeURIComponent(text);
        
        fetch(url)
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Translation API error: ' + response.status);
            }
            return response.json();
          })
          .then(function(data) {
            // Google Translate API returns nested arrays
            // Format: [[[translated_text, original_text, null, null, score]]]
            if (data && data[0] && data[0][0] && data[0][0][0]) {
              var translated = '';
              for (var i = 0; i < data[0].length; i++) {
                if (data[0][i][0]) {
                  translated += data[0][i][0];
                }
              }
              resolve(translated || text);
            } else {
              console.warn('Unexpected translation response format');
              resolve(text);
            }
          })
          .catch(function(error) {
            console.error('Translation error:', error);
            resolve(text); // Fallback to original text
          });
      });
    }

    function createCommentSection(postId) {
      var section = document.createElement('div');
      section.className = 'comment-section';
      
      var heading = document.createElement('h3');
      heading.textContent = 'Comments';
      section.appendChild(heading);
      
      var form = document.createElement('div');
      form.className = 'comment-form';
      
      var nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.id = 'name-' + postId;
      nameInput.placeholder = 'Your name';
      nameInput.required = true;
      nameInput.maxLength = 50;
      
      var commentInput = document.createElement('textarea');
      commentInput.id = 'comment-' + postId;
      commentInput.placeholder = 'Write your comment...';
      commentInput.required = true;
      commentInput.maxLength = 1000;
      
      var button = document.createElement('button');
      button.textContent = 'Post Comment';
      button.setAttribute('data-post-id', postId);
      button.addEventListener('click', function() {
        submitComment(this.getAttribute('data-post-id'));
      });
      
      form.appendChild(nameInput);
      form.appendChild(commentInput);
      form.appendChild(button);
      section.appendChild(form);
      
      var commentsContainer = document.createElement('div');
      commentsContainer.id = 'comments-' + postId;
      commentsContainer.className = 'comments-container';
      commentsContainer.innerHTML = '<p class="loading">Loading comments...</p>';
      section.appendChild(commentsContainer);
      
      return section;
    }

    function submitComment(postId) {
      var nameInput = document.getElementById('name-' + postId);
      var commentInput = document.getElementById('comment-' + postId);
      var button = event.target;
      
      var name = nameInput.value.trim();
      var text = commentInput.value.trim();
      
      if (!name || !text) {
        alert('Please fill in both your name and comment');
        return;
      }
      
      button.disabled = true;
      
      var comment = {
        id: Date.now().toString(),
        author: name,
        text: text,
        date: new Date().toISOString(),
        timestamp: Date.now()
      };
      
      commentsStore[postId].push(comment);
      saveCommentsToStorage(commentsStore);
      
      nameInput.value = '';
      commentInput.value = '';
      
      renderComments(postId);
      
      button.disabled = false;
      
      var originalText = button.textContent;
      button.textContent = 'Posted!';
      setTimeout(function() {
        button.textContent = originalText;
      }, 2000);
    }

    function renderComments(postId) {
      var container = document.getElementById('comments-' + postId);
      var comments = commentsStore[postId] || [];
      
      if (comments.length === 0) {
        container.innerHTML = '<p class="no-comments">No comments yet. Be the first to comment!</p>';
        return;
      }
      
      var sortedComments = comments.slice().sort(function(a, b) {
        return b.timestamp - a.timestamp;
      });
      
      var commentsList = document.createElement('ul');
      commentsList.className = 'comments-list';
      
      sortedComments.forEach(function(comment) {
        var li = document.createElement('li');
        li.className = 'comment';
        
        var date = new Date(comment.date);
        var dateStr = date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        li.innerHTML = '<div class="comment-header"><span class="comment-author">' + escapeHtml(comment.author) + '</span><span class="comment-date">' + dateStr + '</span></div><div class="comment-text">' + escapeHtml(comment.text) + '</div>';
        commentsList.appendChild(li);
      });
      
      container.innerHTML = '';
      container.appendChild(commentsList);
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Add footnote functionality
    window.addFootnote = function(postId, number, text) {
      if (!footnotesStore[postId]) {
        footnotesStore[postId] = [];
      }
      
      // Check if footnote already exists
      var existing = footnotesStore[postId].find(function(fn) {
        return fn.number === number;
      });
      
      if (existing) {
        existing.text = text;
      } else {
        footnotesStore[postId].push({
          number: number,
          text: text
        });
      }
      
      // Sort by number
      footnotesStore[postId].sort(function(a, b) {
        return a.number - b.number;
      });
      
      saveFootnotesToStorage(footnotesStore);
      renderFootnotes(postId);
    };
  </script>
</body>
</html>